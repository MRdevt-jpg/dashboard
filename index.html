<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Mein Dashboard â€“ Wochenplan & Finanzen</title>
  <meta name="theme-color" content="#0f172a" />
  <style>
    :root{
      --bg:#0f172a;--card:#111827;--muted:#1f2937;--text:#e5e7eb;--sub:#9ca3af;
      --blue:#38bdf8;--green:#22c55e;--red:#ef4444;
    }
    *{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
    body{margin:0;background:linear-gradient(180deg,#0b1222,#0f172a);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif}
    header{position:sticky;top:0;background:rgba(15,23,42,.88);backdrop-filter:blur(8px);border-bottom:1px solid #1f2937;z-index:10}
    .wrap{max-width:1100px;margin:auto;padding:16px}
    h1{margin:0 0 6px;font-size:clamp(20px,3vw,28px)}
    .sub{color:var(--sub);font-size:13px}

    /* mehr Platz unten fÃ¼r die groÃŸe Bottom-Navigation */
    main{padding:22px 0 calc(env(safe-area-inset-bottom,0) + 110px)}
    .grid{display:grid;gap:14px}
    .cols-3{grid-template-columns:repeat(3,1fr)}
    @media(max-width:980px){.cols-3{grid-template-columns:1fr}}
    .card{background:var(--card);border:1px solid #1f2937;border-radius:16px;padding:14px}
    .card h2{margin:0 0 10px}
    .row{display:flex;gap:10px;align-items:center}
    .grow{flex:1}
    .kpi{font-weight:700;font-size:26px}
    input,select,textarea{background:#0b1324;color:var(--text);border:1px solid #263248;border-radius:12px;padding:12px;font-size:16px}
    input[type="time"],input[type="date"],input[type="month"]{padding:10px}
    table{width:100%;border-collapse:separate;border-spacing:0 6px}
    thead th{font-weight:600;color:#93c5fd;text-align:left;font-size:12px}
    tbody td{background:#0b1324;border:1px solid #1e293b;padding:8px;vertical-align:top}
    .small{font-size:12px;color:#94a3b8}
    .slot{border-radius:10px;border:1px dashed #334155;padding:8px}
    .slot[data-type="Fix"]{border-color:#1d4ed8;background:#0b1224}
    .slot[data-type="Fokus"]{border-color:#16a34a;background:#071a12}
    .slot[data-type="Lernen"]{border-color:#a855f7;background:#140b24}
    .slot[data-type="Custom"]{border-color:#64748b;background:#0c1118}
    .tag{font-size:11px;color:#93c5fd}

    /* ===== GroÃŸe, abgerundete Bottom Navigation mit Blur & Schatten ===== */
    .bottom-nav{
      position:fixed;
      left:12px;
      right:12px;
      bottom:12px;
      display:flex;
      gap:10px;
      justify-content:space-between;
      background:rgba(17,24,39,.92);
      backdrop-filter:blur(10px);
      border:1px solid #1f2937;
      border-radius:22px;
      padding:10px 12px calc(env(safe-area-inset-bottom,0) + 10px);
      box-shadow:0 10px 30px rgba(0,0,0,.45);
      z-index:20;
    }
    .bottom-nav .tab{
      flex:1;
      min-height:52px;
      background:#0b1324;
      color:#e5e7eb;
      border:none;
      border-radius:14px;
      font-size:15px;
      font-weight:700;
      padding:12px 16px;
      cursor:pointer;
    }
    .bottom-nav .tab.active{
      background:#0ea5e9;
      color:#082f49;
      box-shadow:inset 0 0 0 1px #38bdf8;
    }

    /* Modal */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:50}
    .modal .box{background:var(--card);border:1px solid #1f2937;border-radius:16px;padding:14px;max-width:520px;width:94%}
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <h1>ðŸ“… Mein Dashboard</h1>
      <div class="sub">Wochenplan (frei planbar) Â· Finanzen (Gehalt, Fixkosten & variable Buchungen) â€“ lokal & offline</div>
    </div>
  </header>

  <main class="wrap">
    <!-- DASHBOARD -->
    <section id="dashboard" class="tabpanel">
      <div class="grid cols-3">
        <div class="card">
          <h2>Heute</h2>
          <div class="small" id="todayDate"></div>
          <div id="todayList" style="max-height:380px;overflow:auto"></div>
        </div>
        <div class="card">
          <h2>Monat â€“ Ãœberblick</h2>
          <div class="row" style="gap:22px;flex-wrap:wrap">
            <div><div class="small">Gehalt</div><div class="kpi" id="kpiSalary">0 â‚¬</div></div>
            <div><div class="small">Fixkosten</div><div class="kpi" id="kpiFixed">0 â‚¬</div></div>
            <div><div class="small">Var. Ausgaben</div><div class="kpi" id="kpiVarOut">0 â‚¬</div></div>
            <div><div class="small">Var. Einnahmen</div><div class="kpi" id="kpiVarIn">0 â‚¬</div></div>
            <div><div class="small">Ãœbrig</div><div class="kpi" id="kpiLeft">0 â‚¬</div></div>
          </div>
          <div class="small" id="kpiRate">Sparrate: 0%</div>
        </div>
        <div class="card">
          <h2>Fokus heute</h2>
          <div class="row" style="margin-bottom:8px">
            <input id="focusInput" class="grow" placeholder="z. B. Wochenplanung erstellen">
            <button class="btn" style="background:#052e2b;border:1px solid #115e59;color:#a7f3d0" id="focusSave">Speichern</button>
          </div>
          <div id="focusDisplay" class="slot" data-type="Custom" style="min-height:56px">Fokus festlegenâ€¦</div>
        </div>
      </div>
    </section>

    <!-- WOCHENPLAN -->
    <section id="plan" class="tabpanel" hidden>
      <div class="card">
        <h2>Wochenplan (Tippen zum Anlegen/Bearbeiten)</h2>
        <div class="small">Auf <b>leere Zelle tippen</b> â†’ neuer Block. Auf <b>Block tippen</b> â†’ bearbeiten. Alles wird lokal gespeichert.</div>
        <div class="row" style="margin:10px 0;gap:10px;flex-wrap:wrap">
          <button class="btn" id="resetPlan">Woche leeren</button>
          <button class="btn" style="background:#052e2b;border:1px solid #115e59;color:#a7f3d0" id="newEvent">Neuer Block</button>
          <a class="btn" id="exportPlan" download="wochenplan.json">Export</a>
          <label class="btn">Import<input type="file" id="importPlan" accept="application/json" hidden></label>
        </div>
        <div id="planTable"></div>
      </div>
    </section>

    <!-- FINANZEN -->
    <section id="finanzen" class="tabpanel" hidden>
      <div class="grid cols-3">
        <div class="card">
          <h2>Gehalt & Fixkosten</h2>
          <div class="row" style="margin-bottom:8px">
            <label class="grow">Monatsgehalt (â‚¬)<br><input id="salaryInput" type="number" inputmode="decimal" step="0.01" placeholder="z. B. 2500"></label>
            <button class="btn" style="background:#052e2b;border:1px solid #115e59;color:#a7f3d0" id="saveSalary">Speichern</button>
          </div>
          <div class="row" style="margin:8px 0">
            <input id="fixName" class="grow" placeholder="Fixkosten (z. B. Miete)">
            <input id="fixAmount" type="number" inputmode="decimal" step="0.01" placeholder="Betrag â‚¬" style="width:140px">
            <button class="btn" style="background:#052e2b;border:1px solid #115e59;color:#a7f3d0" id="addFix">HinzufÃ¼gen</button>
          </div>
          <div class="small">Fixkosten werden jeden Monat automatisch berÃ¼cksichtigt.</div>
          <div style="max-height:220px;overflow:auto;margin-top:8px">
            <table>
              <thead><tr><th>Bezeichnung</th><th>Betrag</th><th></th></tr></thead>
              <tbody id="fixTable"></tbody>
            </table>
          </div>
        </div>

        <div class="card">
          <h2>Variable Buchungen</h2>
          <div class="row" style="margin-bottom:6px">
            <select id="txType"><option>Einnahme</option><option>Ausgabe</option></select>
            <input id="txCat" class="grow" placeholder="Kategorie">
          </div>
          <div class="row" style="margin-bottom:6px">
            <input id="txAmount" type="number" inputmode="decimal" step="0.01" placeholder="Betrag â‚¬" class="grow">
            <input id="txDate" type="date" class="grow">
          </div>
          <div class="row" style="margin-bottom:6px">
            <input id="txNote" class="grow" placeholder="Notiz (optional)">
          </div>
          <div class="row">
            <button class="btn" style="background:#052e2b;border:1px solid #115e59;color:#a7f3d0" id="addTx">HinzufÃ¼gen</button>
            <button class="btn" style="background:#3b0b0e;border:1px solid #7f1d1d;color:#fecaca" id="clearTx">Variable Buchungen lÃ¶schen</button>
          </div>
        </div>

        <div class="card">
          <h2>MonatsÃ¼bersicht</h2>
          <div class="row" style="gap:8px;margin-bottom:8px">
            <label>Monat: <input type="month" id="monthPicker"></label>
            <button class="btn" id="exportTx">CSV Export</button>
          </div>
          <div class="row" style="gap:22px;flex-wrap:wrap">
            <div><div class="small">Gehalt</div><div class="kpi" id="mSalary">0 â‚¬</div></div>
            <div><div class="small">Fixkosten</div><div class="kpi" id="mFixed">0 â‚¬</div></div>
            <div><div class="small">Var. Einnahmen</div><div class="kpi" id="mIn">0 â‚¬</div></div>
            <div><div class="small">Var. Ausgaben</div><div class="kpi" id="mOut">0 â‚¬</div></div>
            <div><div class="small">Ãœbrig</div><div class="kpi" id="mLeft">0 â‚¬</div></div>
          </div>
          <div class="small" id="mRate">Sparrate: 0%</div>
          <div style="max-height:240px;overflow:auto;margin-top:8px">
            <table>
              <thead><tr><th>Datum</th><th>Typ</th><th>Kategorie</th><th>Betrag</th><th>Notiz</th><th></th></tr></thead>
              <tbody id="txTable"></tbody>
            </table>
          </div>
        </div>
      </div>
    </section>

    <!-- Block-Modal -->
    <div class="modal" id="eventModal" aria-modal="true" role="dialog">
      <div class="box">
        <h3>Block erstellen / bearbeiten</h3>
        <div class="row" style="flex-wrap:wrap;gap:8px">
          <label>Tag<br><select id="evDay"></select></label>
          <label>Start<br><input id="evStart" type="time" value="06:00"></label>
          <label>Ende<br><input id="evEnd" type="time" value="07:00"></label>
          <label>Typ<br>
            <select id="evType">
              <option>Custom</option><option>Fix</option><option>Fokus</option><option>Lernen</option>
            </select>
          </label>
        </div>
        <div style="margin:8px 0"><label>Text<br><input id="evText" class="grow" placeholder="Block-Beschreibung"></label></div>
        <div class="row" style="justify-content:flex-end;gap:8px">
          <button class="btn" style="background:#3b0b0e;border:1px solid #7f1d1d;color:#fecaca" id="evDelete">LÃ¶schen</button>
          <button class="btn" id="evCancel">Abbrechen</button>
          <button class="btn" style="background:#052e2b;border:1px solid #115e59;color:#a7f3d0" id="evSave">Speichern</button>
        </div>
      </div>
    </div>
  </main>

  <!-- BOTTOM NAV -->
  <div class="bottom-nav">
    <button class="tab" data-tab="dashboard">Dashboard</button>
    <button class="tab" data-tab="plan">Wochenplan</button>
    <button class="tab" data-tab="finanzen">Finanzen</button>
  </div>

  <script>
    /* --- helpers / storage --- */
    const $ = s=>document.querySelector(s);
    const $$ = s=>Array.from(document.querySelectorAll(s));
    const store = { get:(k,d)=>{try{return JSON.parse(localStorage.getItem(k)) ?? d}catch{return d}}, set:(k,v)=>localStorage.setItem(k,JSON.stringify(v)) };
    const euro = n => (n||0).toLocaleString('de-DE',{style:'currency',currency:'EUR'});
    const days = ['Montag','Dienstag','Mittwoch','Donnerstag','Freitag','Samstag','Sonntag'];
    const pad = n=>String(n).padStart(2,'0');
    const hours = Array.from({length:17},(_,i)=>i+6); // 06..22

    /* --- bottom tab router (hash + active class) --- */
    function showTab(id){
      document.location.hash = id;
      $$('.tab').forEach(b=>b.classList.toggle('active', b.dataset.tab===id));
      $$('.tabpanel').forEach(s=>s.hidden = s.id!==id);
    }
    $$('.bottom-nav .tab').forEach(b=>b.addEventListener('click',()=>showTab(b.dataset.tab)));
    window.addEventListener('hashchange',()=>showTab((location.hash||'#dashboard').slice(1)));
    // initial
    showTab((location.hash||'#dashboard').slice(1));

    /* --- free plan --- */
    const PLAN_KEY='plan_v3';
    let plan = store.get(PLAN_KEY, {Montag:[],Dienstag:[],Mittwoch:[],Donnerstag:[],Freitag:[],Samstag:[],Sonntag:[]});
    const savePlan=()=>store.set(PLAN_KEY,plan);

    function findSlot(day, startLabel){
      const list=plan[day]||[];
      for(const [s,e,t,type] of list){ if(s<=startLabel && e>startLabel) return {start:s,end:e,text:t,type}; }
      return null;
    }
    function buildPlanTable(){
      const container = $('#planTable'); container.innerHTML='';
      const table=document.createElement('table');
      const thead=document.createElement('thead'); const trh=document.createElement('tr');
      trh.appendChild(Object.assign(document.createElement('th'),{textContent:'Zeit'}));
      days.forEach(d=>{const th=document.createElement('th'); th.textContent=d; trh.appendChild(th);});
      thead.appendChild(trh); table.appendChild(thead);
      const tbody=document.createElement('tbody');

      hours.forEach(h=>{
        const tr=document.createElement('tr');
        const label=`${pad(h)}:00`;
        const td0=document.createElement('td'); td0.textContent=label; td0.className='small'; tr.appendChild(td0);
        days.forEach(day=>{
          const td=document.createElement('td'); td.dataset.day=day; td.dataset.hour=label;
          td.addEventListener('click',e=>{ if(e.target.closest('.slot')) return; openEventModal({day,start:label,end:pad(h+1)+':00',type:'Custom',text:''}); });
          const slot=findSlot(day,label);
          if(slot){
            const el=document.createElement('div');
            el.className='slot'; el.dataset.type=slot.type;
            el.innerHTML=`<div class="row"><strong class="grow">${slot.text}</strong><span class="small">${slot.start}â€“${slot.end}</span></div><div class="tag">${slot.type}</div>`;
            el.addEventListener('click',()=>openEventModal({day,start:slot.start,end:slot.end,type:slot.type,text:slot.text}));
            td.appendChild(el);
          }else{
            const empty=document.createElement('div'); empty.className='slot'; empty.textContent='â€”'; td.appendChild(empty);
          }
          tr.appendChild(td);
        });
        tbody.appendChild(tr);
      });
      table.appendChild(tbody);
      container.appendChild(table);
    }
    $('#resetPlan').addEventListener('click',()=>{ if(confirm('Alle Wochen-BlÃ¶cke lÃ¶schen?')){ plan = {Montag:[],Dienstag:[],Mittwoch:[],Donnerstag:[],Freitag:[],Samstag:[],Sonntag:[]}; savePlan(); buildPlanTable(); renderToday(); } });
    $('#exportPlan').addEventListener('click',e=>{ const blob=new Blob([JSON.stringify(plan,null,2)],{type:'application/json'}); e.target.href=URL.createObjectURL(blob); });
    $('#importPlan').addEventListener('change',async e=>{ const f=e.target.files[0]; if(!f) return; try{ plan=JSON.parse(await f.text()); savePlan(); buildPlanTable(); renderToday(); }catch{ alert('UngÃ¼ltige Datei'); } e.target.value=''; });
    $('#newEvent').addEventListener('click',()=>openEventModal({day:days[0],start:'06:00',end:'07:00',type:'Custom',text:''}));

    /* --- event modal --- */
    let editing=null;
    function openEventModal(obj){
      editing=obj;
      $('#evDay').innerHTML = days.map(d=>`<option ${d===obj.day?'selected':''}>${d}</option>`).join('');
      $('#evStart').value=obj.start; $('#evEnd').value=obj.end; $('#evType').value=obj.type; $('#evText').value=obj.text||'';
      $('#eventModal').style.display='flex';
    }
    function closeEvent(){ $('#eventModal').style.display='none'; editing=null; }
    $('#evCancel').addEventListener('click',closeEvent);
    $('#eventModal').addEventListener('click',e=>{ if(e.target.id==='eventModal') closeEvent(); });
    $('#evSave').addEventListener('click',()=>{
      const day=$('#evDay').value, s=$('#evStart').value, e=$('#evEnd').value, t=$('#evText').value.trim(), type=$('#evType').value;
      if(!t) return alert('Bitte Text eingeben.'); if(s>=e) return alert('Ende muss nach Start liegen.');
      plan[day]=plan[day]||[]; plan[day]=plan[day].filter(([S,E])=> E<=s || S>=e );
      plan[day].push([s,e,t,type]); plan[day].sort((a,b)=>a[0].localeCompare(b[0]));
      savePlan(); buildPlanTable(); renderToday(); closeEvent();
    });
    $('#evDelete').addEventListener('click',()=>{
      if(!editing){ closeEvent(); return; }
      const {day,start,text}=editing;
      plan[day]=plan[day].filter(([s,,t])=>!(s===start && t===text));
      savePlan(); buildPlanTable(); renderToday(); closeEvent();
    });

    /* --- today & focus --- */
    const weekdayName = d => days[(d.getDay()+6)%7];
    const FOCUS_KEY='focus_today_v1';
    function renderToday(){
      const now=new Date(); const day=weekdayName(now);
      $('#todayDate').textContent=now.toLocaleDateString('de-DE',{weekday:'long',day:'2-digit',month:'2-digit',year:'numeric'});
      const list=(plan[day]||[]).slice().sort((a,b)=>a[0].localeCompare(b[0]));
      const wrap=document.createElement('div');
      list.forEach(([s,e,t,type])=>{ const div=document.createElement('div'); div.className='slot'; div.dataset.type=type; div.style.marginBottom='8px'; div.innerHTML=`<div class="row"><strong class="grow">${t}</strong><span class="small">${s}â€“${e}</span></div><div class="tag">${type}</div>`; wrap.appendChild(div); });
      const c=$('#todayList'); c.innerHTML=''; c.appendChild(wrap);
    }
    $('#focusSave').addEventListener('click',()=>{ store.set(FOCUS_KEY,{date:new Date().toDateString(),text:$('#focusInput').value}); renderFocus(); });
    function renderFocus(){ const v=store.get(FOCUS_KEY,{}); $('#focusDisplay').textContent = (v.text && v.date===new Date().toDateString()) ? v.text : 'Fokus festlegenâ€¦'; }

    /* --- finance --- */
    const SALARY_KEY='salary_v1', FIX_KEY='fix_v1', TX_KEY='tx_v3';
    let salary=Number(store.get(SALARY_KEY,0));
    let fix=store.get(FIX_KEY,[]); // [{id,name,amount}]
    let tx=store.get(TX_KEY,[]);   // variable

    $('#salaryInput').value = salary || '';
    $('#saveSalary').addEventListener('click',()=>{ salary=parseFloat($('#salaryInput').value||'0'); store.set(SALARY_KEY,salary); renderFinance(); });

    function renderFix(){
      const tb=$('#fixTable'); tb.innerHTML='';
      fix.forEach(item=>{
        const tr=document.createElement('tr');
        tr.innerHTML=`<td>${item.name}</td><td>${euro(item.amount)}</td>`;
        const td=document.createElement('td');
        const b=document.createElement('button'); b.className='btn'; b.style.cssText='background:#3b0b0e;border:1px solid #7f1d1d;color:#fecaca'; b.textContent='Ã—';
        b.addEventListener('click',()=>{ fix=fix.filter(f=>f.id!==item.id); store.set(FIX_KEY,fix); renderFinance(); });
        td.appendChild(b); tr.appendChild(td); tb.appendChild(tr);
      });
    }
    $('#addFix').addEventListener('click',()=>{
      const name=$('#fixName').value.trim(); const amount=parseFloat($('#fixAmount').value||'0');
      if(!name || !amount) return alert('Bezeichnung und Betrag angeben.');
      fix.push({id:crypto.randomUUID(),name,amount}); store.set(FIX_KEY,fix);
      $('#fixName').value=''; $('#fixAmount').value=''; renderFinance();
    });

    $('#addTx').addEventListener('click',()=>{
      const type=$('#txType').value; const cat=$('#txCat').value.trim();
      const amount=parseFloat($('#txAmount').value||'0'); const date=$('#txDate').value || new Date().toISOString().slice(0,10);
      const note=$('#txNote').value.trim();
      if(!amount) return alert('Betrag angeben.');
      tx.push({id:crypto.randomUUID(),type,cat,amount,date,note});
      store.set(TX_KEY,tx);
      ['txCat','txAmount','txNote'].forEach(id=>$('#'+id).value=''); renderFinance();
    });
    $('#clearTx').addEventListener('click',()=>{ if(confirm('Alle variablen Buchungen lÃ¶schen?')){ tx=[]; store.set(TX_KEY,tx); renderFinance(); }});

    function renderTxTable(month){
      const tbody=$('#txTable'); tbody.innerHTML='';
      tx.filter(t=>t.date.startsWith(month)).sort((a,b)=>a.date.localeCompare(b.date)).forEach(row=>{
        const tr=document.createElement('tr');
        const val = row.type==='Ausgabe' ? -row.amount : row.amount;
        tr.innerHTML=`<td>${row.date}</td><td>${row.type}</td><td>${row.cat||''}</td><td>${euro(val)}</td><td>${row.note||''}</td>`;
        const td=document.createElement('td'); const del=document.createElement('button'); del.className='btn'; del.style.cssText='background:#3b0b0e;border:1px solid #7f1d1d;color:#fecaca'; del.textContent='Ã—';
        del.addEventListener('click',()=>{ tx=tx.filter(t=>t.id!==row.id); store.set(TX_KEY,tx); renderFinance(); });
        td.appendChild(del); tr.appendChild(td); tbody.appendChild(tr);
      });
    }

    function renderFinance(){
      const m = $('#monthPicker').value || new Date().toISOString().slice(0,7);
      const fixedSum = fix.reduce((a,b)=>a+b.amount,0);
      const varIn = tx.filter(t=>t.date.startsWith(m)&&t.type==='Einnahme').reduce((a,b)=>a+b.amount,0);
      const varOut = tx.filter(t=>t.date.startsWith(m)&&t.type==='Ausgabe').reduce((a,b)=>a+b.amount,0);
      const left = (salary + varIn) - (fixedSum + varOut);

      $('#kpiSalary').textContent=euro(salary);
      $('#kpiFixed').textContent=euro(fixedSum);
      $('#kpiVarIn').textContent=euro(varIn);
      $('#kpiVarOut').textContent=euro(varOut);
      $('#kpiLeft').textContent=euro(left);
      $('#kpiRate').textContent=`Sparrate: ${salary? Math.round((left/salary)*100):0}%`;

      $('#mSalary').textContent=euro(salary);
      $('#mFixed').textContent=euro(fixedSum);
      $('#mIn').textContent=euro(varIn);
      $('#mOut').textContent=euro(varOut);
      $('#mLeft').textContent=euro(left);
      $('#mRate').textContent=`Sparrate: ${salary? Math.round((left/salary)*100):0}%`;

      renderFix(); renderTxTable(m);
    }
    $('#monthPicker').addEventListener('change',renderFinance);
    $('#exportTx').addEventListener('click',()=>{
      const m=$('#monthPicker').value || new Date().toISOString().slice(0,7);
      const rows=tx.filter(t=>t.date.startsWith(m)).map(t=>[t.date,t.type,t.cat,t.amount,t.note].join(';'));
      const csv=['Datum;Typ;Kategorie;Betrag;Notiz',...rows].join('\n');
      const blob=new Blob([csv],{type:'text/csv'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=`buchungen_${m}.csv`; a.click();
    });

    /* --- PWA: manifest + icons + SW --- */
    let deferredPrompt=null;
    function makeIcon(size){ const c=document.createElement('canvas'); c.width=c.height=size; const ctx=c.getContext('2d'); ctx.fillStyle='#0f172a'; ctx.fillRect(0,0,size,size); ctx.fillStyle='#083344'; const r=Math.round(size*0.18),w=size*0.84,h=size*0.84,x=(size-w)/2,y=(size-h)/2; ctx.beginPath(); ctx.moveTo(x+r,y); ctx.arcTo(x+w,y,x+w,y+h,r); ctx.arcTo(x+w,y+h,x,y+h,r); ctx.arcTo(x,y+h,x,y,r); ctx.arcTo(x,y,x+w,y,r); ctx.closePath(); ctx.fill(); ctx.fillStyle='#22c55e'; ctx.font=`${Math.round(size*0.52)}px Inter, Segoe UI, Roboto, Arial`; ctx.textAlign='center'; ctx.textBaseline='middle'; ctx.fillText('M', size*0.47, size*0.55); return c.toDataURL('image/png'); }
    function setupManifest(){
      const icon192=makeIcon(192), icon512=makeIcon(512), apple180=makeIcon(180);
      const apple=document.createElement('link'); apple.rel='apple-touch-icon'; apple.href=apple180; document.head.appendChild(apple);
      const fav=document.createElement('link'); fav.rel='icon'; fav.href=icon192; fav.type='image/png'; document.head.appendChild(fav);
      const manifest = {name:"Mein Dashboard", short_name:"Dashboard", start_url:".", scope:".", display:"standalone", background_color:"#0f172a", theme_color:"#0f172a", icons:[{src:icon192,sizes:"192x192",type:"image/png",purpose:"any maskable"},{src:icon512,sizes:"512x512",type:"image/png",purpose:"any maskable"}]};
      const blob=new Blob([JSON.stringify(manifest)],{type:'application/manifest+json'}); const url=URL.createObjectURL(blob); const link=document.createElement('link'); link.rel='manifest'; link.href=url; document.head.appendChild(link);
    }
    function setupServiceWorker(){
      if(!('serviceWorker' in navigator)) return;
      const sw = `
self.addEventListener('install',e=>{e.waitUntil(caches.open('dash-cache-v1').then(c=>c.addAll(['./']))); self.skipWaiting();});
self.addEventListener('activate',e=>{e.waitUntil(self.clients.claim());});
self.addEventListener('fetch',e=>{e.respondWith(caches.match(e.request).then(r=>r||fetch(e.request).then(res=>{const copy=res.clone(); caches.open('dash-cache-v1').then(c=>c.put(e.request,copy)); return res;})).catch(()=>caches.match('./')));});`;
      const blob=new Blob([sw],{type:'text/javascript'}); const url=URL.createObjectURL(blob); navigator.serviceWorker.register(url);
    }
    window.addEventListener('beforeinstallprompt',(e)=>{ e.preventDefault(); deferredPrompt=e; });

    /* --- init --- */
    (function init(){
      setupManifest(); setupServiceWorker();
      $('#monthPicker').value = new Date().toISOString().slice(0,7);
      document.getElementById('todayDate').textContent =
        new Date().toLocaleDateString('de-DE',{weekday:'long',day:'2-digit',month:'2-digit',year:'numeric'});
      buildPlanTable(); renderToday(); renderFocus(); renderFinance();
      // aktiven Tab in Bottom-Nav markieren
      const cur=(location.hash||'#dashboard').slice(1); $$('.bottom-nav .tab').forEach(b=>b.classList.toggle('active',b.dataset.tab===cur));
    })();
  </script>
</body>
</html>
