<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Mein Dashboard</title>
  <meta name="theme-color" content="#0f172a" />
  <style>
    :root{
      --bg:#0f172a;--card:#111827;--muted:#1f2937;--text:#e5e7eb;--sub:#9ca3af;
      --blue:#38bdf8;--green:#22c55e;--red:#ef4444;
    }
    *{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
    html,body{height:100%}
    body{margin:0;background:linear-gradient(180deg,#0b1222,#0f172a);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif}

    .wrap{max-width:1100px;margin:auto;padding:16px}
    main{padding:12px 0 calc(env(safe-area-inset-bottom,0) + 110px)}

    .grid{display:grid;gap:14px}
    .cols-2{grid-template-columns:repeat(2,1fr)}
    @media(max-width:900px){.cols-2{grid-template-columns:1fr}}

    .card{background:var(--card);border:1px solid #1f2937;border-radius:16px;padding:14px}
    .card h2{margin:0 0 10px}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .col{display:flex;flex-direction:column;gap:10px}
    .grow{flex:1}
    .kpi{font-weight:700;font-size:26px}
    .small{font-size:12px;color:#94a3b8}

    input,select,textarea,button{font-size:16px}
    input,select,textarea{
      width:100%; background:#0b1324;color:var(--text);
      border:1px solid #263248;border-radius:14px;padding:12px
    }
    textarea{min-height:120px}

    /* Buttons – größer & runder */
    .btn{
      background:#0b1324;color:#e5e7eb;border:1px solid #263248;
      padding:14px 16px;border-radius:16px;cursor:pointer;font-weight:600
    }
    .btn.primary{background:#083344;border-color:#155e75}
    .btn.success{background:#052e2b;border-color:#115e59;color:#a7f3d0}
    .btn.danger{background:#3b0b0e;border-color:#7f1d1d;color:#fecaca}

    /* Tabelle */
    table{width:100%;border-collapse:separate;border-spacing:0 6px;min-width:980px}
    thead th{font-weight:600;color:#93c5fd;text-align:left;font-size:12px;background:#0f172a;position:sticky;top:0;z-index:1}
    tbody td{background:#0b1324;border:1px solid #1e293b;padding:8px;vertical-align:top}

    /* Sticky erste Spalte (Zeit) */
    thead th:first-child,
    tbody td:first-child{
      position:sticky; left:0; z-index:2; background:#0f172a;
      border-right:1px solid #1e293b;
    }

    /* Plan-Blöcke */
    .slot{border-radius:12px;border:1px dashed #334155;padding:10px;margin-bottom:8px}
    .slot[data-type="Fix"]{border-color:#1d4ed8;background:#0b1224}
    .slot[data-type="Fokus"]{border-color:#16a34a;background:#071a12}
    .slot[data-type="Lernen"]{border-color:#a855f7;background:#140b24}
    .slot[data-type="Custom"]{border-color:#64748b;background:#0c1118}

    /* Bottom Navigation – groß & rund */
    .bottom-nav{
      position:fixed;left:14px;right:14px;bottom:14px;display:flex;gap:10px;
      justify-content:space-between;align-items:center;
      background:rgba(17,24,39,.92);backdrop-filter:blur(12px);
      border:1px solid #1f2937;border-radius:22px;
      padding:10px 12px calc(env(safe-area-inset-bottom,0) + 12px);
      box-shadow:0 14px 34px rgba(0,0,0,.45);
      z-index:20
    }
    .bottom-nav .tab{
      flex:1;min-height:54px;background:#0b1324;color:#e5e7eb;border:none;
      border-radius:16px;font-size:15px;font-weight:700;padding:14px 10px;cursor:pointer
    }
    .bottom-nav .tab.active{background:#0ea5e9;color:#082f49;box-shadow:inset 0 0 0 1px #38bdf8}

    /* Modal (nur im Plan benutzt) */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:50}
    .modal .box{background:var(--card);border:1px solid #1f2937;border-radius:18px;padding:16px;max-width:520px;width:94%}

    /* Wochenplan Wrapper für Mobil-Scroll */
    #planTable{overflow:auto;max-width:100%}

    /* ----- Finanzen: Handyfreundlich ----- */
    .kpi-row{display:flex;gap:16px;flex-wrap:wrap}
    .kpi-card{background:#0b1324;border:1px solid #1e293b;border-radius:14px;padding:12px;min-width:130px}
    .kpi-val{font-size:22px;font-weight:700}
    .accordion{border:1px solid #1e293b;border-radius:14px;overflow:hidden;background:#0b1324}
    .accordion summary{
      list-style:none;cursor:pointer;padding:12px 14px;font-weight:700;color:#dbeafe;
      display:flex;justify-content:space-between;align-items:center
    }
    .accordion summary::-webkit-details-marker{display:none}
    .accordion .content{padding:12px}
    @media(max-width:900px){
      .accordion .content{overflow:auto}
      table{min-width:720px}
    }

    /* Journal-Kartenliste */
    .journal-item{border:1px solid #1e293b;border-radius:12px;background:#0b1324;padding:10px;margin-top:8px}
    .pill{display:inline-block;background:#0b1324;border:1px solid #263248;color:#bfdbfe;border-radius:999px;padding:3px 8px;font-size:12px}
  </style>
</head>
<body>
  <main class="wrap">
    <!-- DASHBOARD: nur HEUTE -->
    <section id="dashboard" class="tabpanel">
      <div class="card">
        <h2>Heute</h2>
        <div class="small" id="todayDate"></div>
        <div id="todayList"></div>
      </div>
    </section>

    <!-- WOCHENPLAN: ganze Woche (Mo–So) -->
    <section id="plan" class="tabpanel" hidden>
      <div class="card">
        <h2>Wochenplan</h2>
        <div class="row" style="margin:10px 0">
          <button class="btn danger" id="resetPlan">Woche leeren</button>
          <button class="btn success" id="newEvent">Neuer Block</button>
        </div>
        <div id="planTable"></div>
      </div>
    </section>

    <!-- FINANZEN -->
    <section id="finanzen" class="tabpanel" hidden>
      <div class="card">
        <h2>Monatsübersicht</h2>
        <div class="row" style="gap:10px;margin-bottom:8px">
          <label>Monat: <input type="month" id="monthPicker"></label>
        </div>
        <div class="kpi-row">
          <div class="kpi-card"><div class="small">Gehalt</div><div class="kpi-val" id="mSalary">0 €</div></div>
          <div class="kpi-card"><div class="small">Fixkosten</div><div class="kpi-val" id="mFixed">0 €</div></div>
          <div class="kpi-card"><div class="small">Einnahmen</div><div class="kpi-val" id="mIn">0 €</div></div>
          <div class="kpi-card"><div class="small">Ausgaben</div><div class="kpi-val" id="mOut">0 €</div></div>
          <div class="kpi-card"><div class="small">Übrig</div><div class="kpi-val" id="mLeft">0 €</div></div>
        </div>
        <div class="small" id="mRate" style="margin-top:6px">Sparrate: 0%</div>
      </div>

      <div class="grid cols-2">
        <div class="card">
          <h2>Eingaben</h2>
          <div class="col">
            <div class="row">
              <input id="salaryInput" type="number" inputmode="decimal" step="0.01" placeholder="Monatsgehalt €" class="grow">
              <button class="btn success" id="saveSalary">Speichern</button>
            </div>
            <div class="row">
              <input id="fixName" class="grow" placeholder="Fixkosten (z. B. Miete)">
              <input id="fixAmount" type="number" inputmode="decimal" step="0.01" placeholder="Betrag €" style="max-width:180px">
              <button class="btn success" id="addFix">Hinzufügen</button>
            </div>
            <hr style="border:none;border-top:1px solid #1e293b;width:100%">
            <div class="row">
              <select id="txType"><option>Einnahme</option><option>Ausgabe</option></select>
              <input id="txCat" class="grow" placeholder="Kategorie (z. B. Essen, Nebenjob)">
            </div>
            <div class="row">
              <input id="txAmount" type="number" inputmode="decimal" step="0.01" placeholder="Betrag €" class="grow">
              <input id="txDate" type="date" class="grow">
            </div>
            <div class="row">
              <button class="btn success" id="addTx">Hinzufügen</button>
              <button class="btn danger" id="clearTx">Variable Buchungen löschen</button>
            </div>
          </div>
        </div>

        <div class="card">
          <h2>Listen</h2>

          <details class="accordion" open>
            <summary>Fixkosten-Liste <span class="pill" id="fixCount">0</span></summary>
            <div class="content">
              <div style="overflow:auto">
                <table>
                  <thead><tr><th>Name</th><th>Betrag</th><th></th></tr></thead>
                  <tbody id="fixTable"></tbody>
                </table>
              </div>
            </div>
          </details>

          <div style="height:10px"></div>

          <details class="accordion">
            <summary>Variable Buchungen <span class="pill" id="txCount">0</span></summary>
            <div class="content">
              <div style="overflow:auto">
                <table>
                  <thead><tr><th>Datum</th><th>Typ</th><th>Kategorie</th><th>Betrag</th><th></th></tr></thead>
                  <tbody id="txTable"></tbody>
                </table>
              </div>
            </div>
          </details>
        </div>
      </div>

      <!-- BACKUP / EINSTELLUNGEN -->
      <div class="card">
        <h2>Backup & Wiederherstellung</h2>
        <div class="row" style="margin-bottom:8px">
          <button class="btn" id="exportAll">Export (JSON)</button>
          <label class="btn">Import (JSON)
            <input type="file" id="importAll" accept="application/json" hidden>
          </label>
        </div>
        <div class="row" style="margin-bottom:8px">
          <button class="btn" id="pickBackupFile">Auto-Backup: Datei auswählen</button>
          <button class="btn" id="backupNow">Jetzt in Datei sichern</button>
          <button class="btn" id="clearBackupFile">Auto-Backup trennen</button>
          <span class="small" id="fileBackupStatus">Datei: nicht verbunden</span>
        </div>
        <div class="small">Tipp: Auf deinem Google Pixel 8 Pro funktioniert das Auto-Backup über die Dateiauswahl hervorragend. Danach wird jede Änderung automatisch in diese Datei geschrieben.</div>
      </div>
    </section>

    <!-- JOURNAL -->
    <section id="journal" class="tabpanel" hidden>
      <div class="card">
        <h2>Journal (täglich)</h2>
        <div class="row" style="gap:10px;margin-bottom:8px">
          <label>Datum: <input type="date" id="jDate"></label>
        </div>
        <div class="grid" style="grid-template-columns:1fr;gap:12px">
          <div>
            <div class="small">Gut</div>
            <textarea id="jGood" placeholder="Was war heute gut?"></textarea>
          </div>
          <div>
            <div class="small">Schlecht</div>
            <textarea id="jBad" placeholder="Was war heute schlecht?"></textarea>
          </div>
          <div>
            <div class="small">Gelernt</div>
            <textarea id="jLearned" placeholder="Was habe ich gelernt?"></textarea>
          </div>
        </div>
        <div class="row" style="margin-top:8px">
          <button class="btn success" id="saveJournal">Speichern</button>
        </div>
        <div id="journalEntries" style="margin-top:10px"></div>
      </div>
    </section>

    <!-- Modal für Wochenplan (nur dort benutzt) -->
    <div class="modal" id="eventModal" aria-modal="true" role="dialog">
      <div class="box">
        <h3>Block erstellen / bearbeiten</h3>
        <div class="row">
          <label>Tag<br><select id="evDay"></select></label>
          <label>Start<br><input id="evStart" type="time" value="06:00"></label>
          <label>Ende<br><input id="evEnd" type="time" value="06:30"></label>
          <label>Typ<br>
            <select id="evType">
              <option>Custom</option><option>Fix</option><option>Fokus</option><option>Lernen</option>
            </select>
          </label>
        </div>
        <div class="row"><input id="evText" class="grow" placeholder="Block-Beschreibung"></div>
        <div class="row" style="justify-content:flex-end;gap:8px">
          <button class="btn danger" id="evDelete">Löschen</button>
          <button class="btn" id="evCancel">Abbrechen</button>
          <button class="btn success" id="evSave">Speichern</button>
        </div>
      </div>
    </div>
  </main>

  <!-- BOTTOM NAV (immer sichtbar) -->
  <div class="bottom-nav">
    <button class="tab" data-tab="dashboard">Dashboard</button>
    <button class="tab" data-tab="plan">Wochenplan</button>
    <button class="tab" data-tab="finanzen">Finanzen</button>
    <button class="tab" data-tab="journal">Journal</button>
  </div>

  <script>
    /* ===== Helpers & Storage ===== */
    const $ = s=>document.querySelector(s);
    const $$ = s=>Array.from(document.querySelectorAll(s));
    const store = { get:(k,d)=>{try{return JSON.parse(localStorage.getItem(k)) ?? d}catch{return d}}, set:(k,v)=>localStorage.setItem(k,JSON.stringify(v)) };
    const euro = n => (n||0).toLocaleString('de-DE',{style:'currency',currency:'EUR'});
    const days = ['Montag','Dienstag','Mittwoch','Donnerstag','Freitag','Samstag','Sonntag'];
    const pad = n=>String(n).padStart(2,'0');

    /* ===== Migration (alte Keys) ===== */
    (function migrate(){
      const oldPlan = store.get('plan_v3', null);
      if (oldPlan && !store.get('plan_v1', null)) store.set('plan_v1', oldPlan);
    })();

    /* ===== Tabs / Router ===== */
    function showTab(id){
      location.hash = id;
      $$('.tab').forEach(b=>b.classList.toggle('active', b.dataset.tab===id));
      $$('.tabpanel').forEach(s=>s.hidden = s.id!==id);
      if(id!=='plan') closeEvent();

      if(id==='dashboard') renderToday();
      if(id==='finanzen')  renderFinance();
      if(id==='journal')   renderJournalEntries();
    }
    $$('.bottom-nav .tab').forEach(b=>b.addEventListener('click',()=>showTab(b.dataset.tab)));
    window.addEventListener('hashchange',()=>showTab((location.hash||'#dashboard').slice(1)));

    /* ===== Zeit-Slots in 30 Minuten ===== */
    function addMinutes(t,mins){
      const [H,M]=t.split(':').map(Number);
      const d=new Date(); d.setHours(H,M,0,0);
      d.setMinutes(d.getMinutes()+mins);
      return `${pad(d.getHours())}:${pad(d.getMinutes())}`;
    }
    function buildTimes(start=6,end=22,step=30){
      const out=[]; let d=new Date(); d.setHours(start,0,0,0);
      const endD=new Date(); endD.setHours(end,0,0,0);
      while(d<=endD){ out.push(`${pad(d.getHours())}:${pad(d.getMinutes())}`); d.setMinutes(d.getMinutes()+step); }
      return out;
    }
    const times = buildTimes(6,22,30); // 06:00 .. 22:00 in 30min

    /* ===== Wochenplan (ganze Woche) ===== */
    let plan = store.get('plan_v1', {Montag:[],Dienstag:[],Mittwoch:[],Donnerstag:[],Freitag:[],Samstag:[],Sonntag:[]});
    const savePlan=()=>{ store.set('plan_v1',plan); autoBackup(); };

    function buildPlanTable(){
      plan = store.get('plan_v1', plan);

      const container = $('#planTable'); container.innerHTML='';
      const table=document.createElement('table');
      const thead=document.createElement('thead'); const trh=document.createElement('tr');
      const thTime=document.createElement('th'); thTime.textContent='Zeit'; trh.appendChild(thTime);
      days.forEach(d=>{const th=document.createElement('th'); th.textContent=d; trh.appendChild(th);});
      thead.appendChild(trh); table.appendChild(thead);
      const tbody=document.createElement('tbody');

      times.forEach(label=>{
        const tr=document.createElement('tr');
        const td0=document.createElement('td'); td0.textContent=label; td0.className='small'; tr.appendChild(td0);
        days.forEach(day=>{
          const td=document.createElement('td');
          td.addEventListener('click',e=>{
            if(location.hash.slice(1)!=='plan') return;
            if(e.target.closest('.slot')) return;
            openEventModal({day,start:label,end:addMinutes(label,30),type:'Custom',text:''});
          });
          const slot=(plan[day]||[]).find(([s,e])=>s<=label && e>label);
          if(slot){
            const el=document.createElement('div');
            el.className='slot'; el.dataset.type=slot[3]||'Custom';
            el.innerHTML=`<div><strong>${slot[2]}</strong></div><div class="small">${slot[0]}–${slot[1]} · ${slot[3]||'Custom'}</div>`;
            el.addEventListener('click',()=>{
              if(location.hash.slice(1)!=='plan') return;
              openEventModal({day,start:slot[0],end:slot[1],type:slot[3]||'Custom',text:slot[2]});
            });
            td.appendChild(el);
          }else{
            const empty=document.createElement('div'); empty.className='slot'; empty.dataset.type='Custom'; empty.textContent='—'; td.appendChild(empty);
          }
          tr.appendChild(td);
        });
        tbody.appendChild(tr);
      });
      table.appendChild(tbody);
      container.appendChild(table);
    }

    let editing=null;
    function openEventModal(obj){
      editing=obj;
      $('#evDay').innerHTML = days.map(d=>`<option ${d===obj.day?'selected':''}>${d}</option>`).join('');
      $('#evStart').value=obj.start||'06:00'; $('#evEnd').value=obj.end||addMinutes($('#evStart').value,30);
      $('#evType').value=obj.type||'Custom'; $('#evText').value=obj.text||'';
      $('#eventModal').style.display = (location.hash.slice(1)==='plan') ? 'flex' : 'none';
    }
    function closeEvent(){ const m=$('#eventModal'); if(m) m.style.display='none'; editing=null; }
    $('#evCancel').addEventListener('click',closeEvent);
    $('#eventModal').addEventListener('click',e=>{ if(e.target.id==='eventModal') closeEvent(); });
    $('#evSave').addEventListener('click',()=>{
      const day=$('#evDay').value, s=$('#evStart').value, e=$('#evEnd').value, t=$('#evText').value.trim(), type=$('#evType').value;
      if(!t) return alert('Bitte Text eingeben.'); if(s>=e) return alert('Ende muss nach Start liegen.');
      plan[day]=plan[day].filter(([S,E])=> E<=s || S>=e );
      plan[day].push([s,e,t,type]); plan[day].sort((a,b)=>a[0].localeCompare(b[0]));
      savePlan(); buildPlanTable(); renderToday(); closeEvent();
    });
    $('#evDelete').addEventListener('click',()=>{
      if(!editing){ closeEvent(); return; }
      const {day,start,text}=editing;
      plan[day]=plan[day].filter(([s,,t])=>!(s===start && t===text));
      savePlan(); buildPlanTable(); renderToday(); closeEvent();
    });
    $('#resetPlan').addEventListener('click',()=>{
      if(confirm('Alle Wochen-Blöcke löschen?')){
        plan = {Montag:[],Dienstag:[],Mittwoch:[],Donnerstag:[],Freitag:[],Samstag:[],Sonntag:[]};
        savePlan(); buildPlanTable(); renderToday();
      }
    });
    $('#newEvent').addEventListener('click',()=>openEventModal({day:days[0],start:'06:00',end:'06:30',type:'Custom',text:''}));

    /* ===== Dashboard (nur heute) ===== */
    function weekdayName(d){ return days[(d.getDay()+6)%7] }
    function renderToday(){
      plan = store.get('plan_v1', plan);
      const now=new Date(); const day=weekdayName(now);
      $('#todayDate').textContent = now.toLocaleDateString('de-DE',{weekday:'long',day:'2-digit',month:'2-digit',year:'numeric'});
      const list=(plan[day]||[]).slice().sort((a,b)=>a[0].localeCompare(b[0]));
      $('#todayList').innerHTML = list.map(([s,e,t,type])=>`<div class="slot" data-type="${type||'Custom'}"><strong>${t}</strong><div class="small">${s}–${e}</div></div>`).join('') || '<div class="small">Heute sind keine Blöcke geplant.</div>';
    }

    /* ===== Finanzen (immer frisch lesen) ===== */
    const SALARY_KEY='salary_v1', FIX_KEY='fix_v1', TX_KEY='tx_v1';

    $('#saveSalary').addEventListener('click',()=>{
      const salaryVal=parseFloat($('#salaryInput').value||'0');
      store.set(SALARY_KEY,salaryVal);
      renderFinance();
      autoBackup();
    });
    $('#addFix').addEventListener('click',()=>{
      const name=$('#fixName').value.trim(); const amount=parseFloat($('#fixAmount').value||'0');
      if(!name || !amount) return alert('Bitte Name & Betrag eingeben.');
      const list = store.get(FIX_KEY,[]);
      list.push({id:crypto.randomUUID(),name,amount});
      store.set(FIX_KEY,list);
      $('#fixName').value=''; $('#fixAmount').value='';
      renderFinance();
      autoBackup();
    });
    $('#addTx').addEventListener('click',()=>{
      const type=$('#txType').value, cat=$('#txCat').value.trim();
      const amount=parseFloat($('#txAmount').value||'0'); const date=$('#txDate').value || new Date().toISOString().slice(0,10);
      if(!amount) return alert('Betrag eingeben.');
      const list=store.get(TX_KEY,[]);
      list.push({id:crypto.randomUUID(),type,cat,amount,date});
      store.set(TX_KEY,list);
      ['txCat','txAmount'].forEach(id=>$('#'+id).value='');
      renderFinance();
      autoBackup();
    });
    $('#clearTx').addEventListener('click',()=>{
      if(confirm('Alle variablen Buchungen löschen?')){
        store.set(TX_KEY,[]);
        renderFinance();
        autoBackup();
      }
    });
    function renderFinance(){
      const salaryNow = Number(store.get(SALARY_KEY,0));
      const fixNow = store.get(FIX_KEY,[]);
      const txNow  = store.get(TX_KEY,[]);
      const m = $('#monthPicker')?.value || new Date().toISOString().slice(0,7);

      const fixedSum = fixNow.reduce((a,b)=>a+b.amount,0);
      const varIn = txNow.filter(t=>t.date.startsWith(m)&&t.type==='Einnahme').reduce((a,b)=>a+b.amount,0);
      const varOut = txNow.filter(t=>t.date.startsWith(m)&&t.type==='Ausgabe').reduce((a,b)=>a+b.amount,0);
      const left = (salaryNow + varIn) - (fixedSum + varOut);

      $('#salaryInput').value = salaryNow || '';
      $('#mSalary').textContent=euro(salaryNow);
      $('#mFixed').textContent=euro(fixedSum);
      $('#mIn').textContent=euro(varIn);
      $('#mOut').textContent=euro(varOut);
      $('#mLeft').textContent=euro(left);
      $('#mRate').textContent=`Sparrate: ${salaryNow? Math.max(0,Math.round((left/salaryNow)*100)):0}%`;

      const tb=$('#fixTable'); tb.innerHTML='';
      fixNow.forEach(item=>{
        const tr=document.createElement('tr');
        tr.innerHTML=`<td>${item.name}</td><td>${euro(item.amount)}</td>`;
        const td=document.createElement('td');
        const b=document.createElement('button'); b.className='btn danger'; b.textContent='×';
        b.addEventListener('click',()=>{
          const newFix = store.get(FIX_KEY,[]).filter(f=>f.id!==item.id);
          store.set(FIX_KEY,newFix);
          renderFinance();
          autoBackup();
        });
        td.appendChild(b); tr.appendChild(td); tb.appendChild(tr);
      });
      $('#fixCount').textContent = String(fixNow.length);

      const tbody=$('#txTable'); tbody.innerHTML='';
      const rows = txNow.filter(t=>t.date.startsWith(m)).sort((a,b)=>a.date.localeCompare(b.date));
      rows.forEach(row=>{
        const tr=document.createElement('tr');
        const val = row.type==='Ausgabe' ? -row.amount : row.amount;
        tr.innerHTML=`<td>${row.date}</td><td>${row.type}</td><td>${row.cat||''}</td><td>${euro(val)}</td>`;
        const td=document.createElement('td'); const del=document.createElement('button'); del.className='btn danger'; del.textContent='×';
        del.addEventListener('click',()=>{
          const newTx = store.get(TX_KEY,[]).filter(t=>t.id!==row.id);
          store.set(TX_KEY,newTx);
          renderFinance();
          autoBackup();
        });
        td.appendChild(del); tr.appendChild(td); tbody.appendChild(tr);
      });
      $('#txCount').textContent = String(rows.length);
    }
    $('#monthPicker')?.addEventListener('change',renderFinance);

    /* ===== Journal (3 Felder) ===== */
    const J_KEY='journal_v2';
    function todayISO(){ return new Date().toISOString().slice(0,10); }
    function loadJournalFor(date){
      const all = store.get(J_KEY,{});
      const entry = all[date] || {good:'',bad:'',learned:''};
      $('#jGood').value = entry.good || '';
      $('#jBad').value = entry.bad || '';
      $('#jLearned').value = entry.learned || '';
    }
    function renderJournalEntries(){
      const all = store.get(J_KEY,{});
      const keys = Object.keys(all).sort().reverse().slice(0,30);
      $('#journalEntries').innerHTML = keys.map(k=>{
        const e = all[k] || {};
        const safe = s => (s||'').replace(/\n/g,'<br>');
        return `<div class="journal-item">
          <div class="small">${k}</div>
          <div style="margin-top:6px"><span class="pill">Gut</span><div>${safe(e.good)}</div></div>
          <div style="margin-top:6px"><span class="pill">Schlecht</span><div>${safe(e.bad)}</div></div>
          <div style="margin-top:6px"><span class="pill">Gelernt</span><div>${safe(e.learned)}</div></div>
        </div>`;
      }).join('') || '<div class="small">Noch keine Einträge.</div>';
    }
    $('#saveJournal').addEventListener('click',()=>{
      const date = $('#jDate').value || todayISO();
      const all = store.get(J_KEY,{});
      all[date] = {
        good: $('#jGood').value,
        bad: $('#jBad').value,
        learned: $('#jLearned').value
      };
      store.set(J_KEY, all);
      renderJournalEntries();
      autoBackup();
    });
    $('#jDate')?.addEventListener('change',()=>{
      const d = $('#jDate').value || todayISO();
      loadJournalFor(d);
    });

    /* ===== Cross-Tab Sync ===== */
    window.addEventListener('storage', (e) => {
      if(['salary_v1','fix_v1','tx_v1'].includes(e.key)){
        if(location.hash.slice(1)==='finanzen') renderFinance();
      }
      if(e.key==='plan_v1'){
        buildPlanTable();
        if(location.hash.slice(1)==='dashboard') renderToday();
      }
      if(e.key==='journal_v2' && location.hash.slice(1)==='journal'){
        renderJournalEntries();
      }
    });

    /* ===== Manuelles Export/Import (JSON) ===== */
    function getAllData(){
      return {
        plan_v1: store.get('plan_v1', {Montag:[],Dienstag:[],Mittwoch:[],Donnerstag:[],Freitag:[],Samstag:[],Sonntag:[]}),
        salary_v1: store.get('salary_v1', 0),
        fix_v1: store.get('fix_v1', []),
        tx_v1: store.get('tx_v1', []),
        journal_v2: store.get('journal_v2', {})
      };
    }
    function setAllData(obj){
      if(!obj || typeof obj!=='object') return;
      if(obj.plan_v1) store.set('plan_v1', obj.plan_v1);
      if(obj.salary_v1!=null) store.set('salary_v1', obj.salary_v1);
      if(obj.fix_v1) store.set('fix_v1', obj.fix_v1);
      if(obj.tx_v1) store.set('tx_v1', obj.tx_v1);
      if(obj.journal_v2) store.set('journal_v2', obj.journal_v2);
      buildPlanTable(); renderToday(); renderFinance(); renderJournalEntries();
      autoBackup();
    }

    $('#exportAll')?.addEventListener('click', ()=>{
      const blob=new Blob([JSON.stringify(getAllData(),null,2)],{type:'application/json'});
      const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='dashboard_backup.json'; a.click();
    });
    $('#importAll')?.addEventListener('change', async (e)=>{
      const f=e.target.files[0]; if(!f) return;
      try{ const obj=JSON.parse(await f.text()); setAllData(obj); alert('Import erfolgreich.'); }
      catch{ alert('Ungültige JSON-Datei.'); }
      e.target.value='';
    });

    /* ===== Auto-Backup in Datei (File System Access + IndexedDB) ===== */
    const FILE_HANDLE_KEY = 'backup_file_handle_v1';

    // Mini-IDB (zum Speichern des FileHandles)
    const idb = {
      db: null,
      async open(){
        if(this.db) return this.db;
        return new Promise((res,rej)=>{
          const r = indexedDB.open('dash-db',1);
          r.onupgradeneeded = ()=>{ r.result.createObjectStore('kv'); };
          r.onsuccess = ()=>{ this.db=r.result; res(this.db); };
          r.onerror = ()=>rej(r.error);
        });
      },
      async get(key){
        const db = await this.open();
        return new Promise((res,rej)=>{
          const tx=db.transaction('kv','readonly'); const st=tx.objectStore('kv');
          const rq=st.get(key); rq.onsuccess=()=>res(rq.result); rq.onerror=()=>rej(rq.error);
        });
      },
      async set(key,val){
        const db = await this.open();
        return new Promise((res,rej)=>{
          const tx=db.transaction('kv','readwrite'); const st=tx.objectStore('kv');
          const rq=st.put(val,key); rq.onsuccess=()=>res(); rq.onerror=()=>rej(rq.error);
        });
      },
      async del(key){
        const db = await this.open();
        return new Promise((res,rej)=>{
          const tx=db.transaction('kv','readwrite'); const st=tx.objectStore('kv');
          const rq=st.delete(key); rq.onsuccess=()=>res(); rq.onerror=()=>rej(rq.error);
        });
      }
    };

    async function getSavedHandle(){ try{ return await idb.get(FILE_HANDLE_KEY); }catch{return null;} }
    async function setSavedHandle(h){ try{ await idb.set(FILE_HANDLE_KEY, h); }catch{} }
    async function clearSavedHandle(){ try{ await idb.del(FILE_HANDLE_KEY); }catch{} }

    async function verifyPermission(fileHandle, write = false){
      try{
        if(!fileHandle) return false;
        const opts = {mode: write ? 'readwrite' : 'read'};
        if(await fileHandle.queryPermission(opts) === 'granted') return true;
        return (await fileHandle.requestPermission(opts)) === 'granted';
      }catch{ return false; }
    }

    async function pickBackupFile(){
      if(!window.showSaveFilePicker){
        alert('Auto-Backup in Datei wird von diesem Browser nicht unterstützt.');
        return null;
      }
      const handle = await showSaveFilePicker({
        suggestedName: 'dashboard_auto_backup.json',
        types: [{description:'JSON', accept:{'application/json':['.json']}}]
      });
      if(!(await verifyPermission(handle,true))) { alert('Keine Schreibrechte.'); return null; }
      await setSavedHandle(handle);
      updateFileBackupStatus(true);
      return handle;
    }

    async function writeBackupToFile(handle){
      try{
        if(!handle) return false;
        const ok = await verifyPermission(handle,true);
        if(!ok) return false;
        const writable = await handle.createWritable();
        await writable.write(new Blob([JSON.stringify(getAllData(),null,2)], {type:'application/json'}));
        await writable.close();
        return true;
      }catch(e){ console.error('Auto-Backup fehlgeschlagen', e); return false; }
    }

    async function autoBackup(){
      const handle = await getSavedHandle();
      if(!handle) return;
      await writeBackupToFile(handle);
    }

    function updateFileBackupStatus(connected){
      $('#fileBackupStatus').textContent = connected ? 'Datei: verbunden' : 'Datei: nicht verbunden';
    }

    $('#pickBackupFile')?.addEventListener('click', async ()=>{
      const h = await pickBackupFile();
      if(h) { await writeBackupToFile(h); alert('Auto-Backup aktiviert.'); }
    });
    $('#clearBackupFile')?.addEventListener('click', async ()=>{
      await clearSavedHandle();
      updateFileBackupStatus(false);
      alert('Auto-Backup getrennt.');
    });
    $('#backupNow')?.addEventListener('click', async ()=>{
      const h = await getSavedHandle();
      if(!h){ alert('Keine Datei verbunden. Bitte zuerst „Auto-Backup: Datei auswählen“.'); return; }
      const ok = await writeBackupToFile(h);
      alert(ok ? 'In Datei gesichert.' : 'Speichern fehlgeschlagen.');
    });

    /* ===== PWA ===== */
    function makeIcon(size){
      const c=document.createElement('canvas'); c.width=c.height=size;
      const ctx=c.getContext('2d');
      ctx.fillStyle='#0f172a'; ctx.fillRect(0,0,size,size);
      const r=Math.round(size*0.18),w=size*0.84,h=size*0.84,x=(size-w)/2,y=(size-h)/2;
      ctx.fillStyle='#083344'; ctx.beginPath();
      ctx.moveTo(x+r,y); ctx.arcTo(x+w,y,x+w,y+h,r); ctx.arcTo(x+w,y+h,x,y+h,r);
      ctx.arcTo(x,y+h,x,y,r); ctx.arcTo(x,y,x+w,y,r); ctx.closePath(); ctx.fill();
      ctx.fillStyle='#22c55e'; ctx.font=`${Math.round(size*0.52)}px Inter, Segoe UI, Roboto, Arial`; ctx.textAlign='center'; ctx.textBaseline='middle';
      ctx.fillText('M', size*0.47, size*0.55);
      return c.toDataURL('image/png');
    }
    function setupManifest(){
      const icon192=makeIcon(192), icon512=makeIcon(512), apple180=makeIcon(180);
      const apple=document.createElement('link'); apple.rel='apple-touch-icon'; apple.href=apple180; document.head.appendChild(apple);
      const fav=document.createElement('link'); fav.rel='icon'; fav.href=icon192; fav.type='image/png'; document.head.appendChild(fav);
      const manifest = {name:"Mein Dashboard", short_name:"Dashboard", start_url:".", scope:".", display:"standalone", background_color:"#0f172a", theme_color:"#0f172a", icons:[{src:icon192,sizes:"192x192",type:"image/png",purpose:"any maskable"},{src:icon512,sizes:"512x512",type:"image/png",purpose:"any maskable"}]};
      const blob=new Blob([JSON.stringify(manifest)],{type:'application/manifest+json'}); const url=URL.createObjectURL(blob); const link=document.createElement('link'); link.rel='manifest'; link.href=url; document.head.appendChild(link);
    }
    function setupServiceWorker(){
      if(!('serviceWorker' in navigator)) return;
      const sw = `
self.addEventListener('install',e=>{e.waitUntil(caches.open('dash-cache-v1').then(c=>c.addAll(['./']))); self.skipWaiting();});
self.addEventListener('activate',e=>{e.waitUntil(self.clients.claim());});
self.addEventListener('fetch',e=>{e.respondWith(caches.match(e.request).then(r=>r||fetch(e.request).then(res=>{const copy=res.clone(); caches.open('dash-cache-v1').then(c=>c.put(e.request,copy)); return res;})).catch(()=>caches.match('./')));});`;
      const blob=new Blob([sw],{type:'text/javascript'}); const url=URL.createObjectURL(blob); navigator.serviceWorker.register(url);
    }

    /* ===== Init ===== */
    (async function init(){
      setupManifest(); setupServiceWorker();

      // Monatpicker setzen, dann Finanzen rendern
      const mp = document.getElementById('monthPicker');
      if(mp){ mp.value = new Date().toISOString().slice(0,7); }

      // Dashboard Today
      $('#todayDate').textContent =
        new Date().toLocaleDateString('de-DE',{weekday:'long',day:'2-digit',month:'2-digit',year:'numeric'});
      renderToday();

      // Journal default
      const today = (new Date()).toISOString().slice(0,10);
      if(document.getElementById('jDate')) document.getElementById('jDate').value = today;
      loadJournalFor(today);
      renderJournalEntries();

      // Finanzen initial
      renderFinance();

      // Wochenplan initial
      buildPlanTable();

      // Auto-Backup: Status aktualisieren
      const handle = await getSavedHandle();
      updateFileBackupStatus(!!handle);

      // Start-Tab
      showTab((location.hash||'#dashboard').slice(1));
    })();
  </script>
</body>
</html>
